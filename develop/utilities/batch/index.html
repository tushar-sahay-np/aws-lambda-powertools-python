
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Utility">
      
      
      
        <meta name="author" content="Amazon Web Services">
      
      
      <link rel="icon" href="../../media/aws-logo-light.svg">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>Batch Processing - Lambda Powertools Python</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,400i,700%7C&display=fallback">
        <style>:root{--md-text-font-family:"Ubuntu";--md-code-font-family:""}</style>
      
    
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#key-features" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Lambda Powertools Python" class="md-header__button md-logo" aria-label="Lambda Powertools Python" data-md-component="logo">
      
  <img src="../../media/aws-logo-light.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Lambda Powertools Python
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Batch Processing
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/awslabs/aws-lambda-powertools-python/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Lambda Powertools Python" class="md-nav__button md-logo" aria-label="Lambda Powertools Python" data-md-component="logo">
      
  <img src="../../media/aws-logo-light.svg" alt="logo">

    </a>
    Lambda Powertools Python
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/awslabs/aws-lambda-powertools-python/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Homepage
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../tutorial/" class="md-nav__link">
        Tutorial
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/awslabs/aws-lambda-powertools-roadmap/projects/1" target="_blank" class="md-nav__link">
        Roadmap
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../api/" target="_blank" class="md-nav__link">
        API reference
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" data-md-state="indeterminate" type="checkbox" id="__nav_6" checked>
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6">
          Core utilities
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Core utilities" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Core utilities
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/tracer/" class="md-nav__link">
        Tracer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/logger/" class="md-nav__link">
        Logger
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/metrics/" class="md-nav__link">
        Metrics
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6_4" data-md-state="indeterminate" type="checkbox" id="__nav_6_4" checked>
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_6_4">
          Event Handler
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Event Handler" data-md-level="2">
        <label class="md-nav__title" for="__nav_6_4">
          <span class="md-nav__icon md-icon"></span>
          Event Handler
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/event_handler/api_gateway/" class="md-nav__link">
        REST API
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/event_handler/appsync/" class="md-nav__link">
        GraphQL API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_7">
          Utilities
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utilities" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Utilities
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../middleware_factory/" class="md-nav__link">
        Middleware factory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../parameters/" class="md-nav__link">
        Parameters
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Batch Processing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Batch Processing
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    Key Features
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting started
  </a>
  
    <nav class="md-nav" aria-label="Getting started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#required-resources" class="md-nav__link">
    Required resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-messages-from-sqs" class="md-nav__link">
    Processing messages from SQS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-messages-from-kinesis" class="md-nav__link">
    Processing messages from Kinesis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-messages-from-dynamodb" class="md-nav__link">
    Processing messages from DynamoDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#partial-failure-mechanics" class="md-nav__link">
    Partial failure mechanics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    Advanced
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pydantic-integration" class="md-nav__link">
    Pydantic integration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-processed-messages" class="md-nav__link">
    Accessing processed messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extending-batchprocessor" class="md-nav__link">
    Extending BatchProcessor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-your-own-partial-processor" class="md-nav__link">
    Create your own partial processor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caveats" class="md-nav__link">
    Caveats
  </a>
  
    <nav class="md-nav" aria-label="Caveats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tracer-response-auto-capture-for-large-batch-sizes" class="md-nav__link">
    Tracer response auto-capture for large batch sizes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-your-code" class="md-nav__link">
    Testing your code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    FAQ
  </a>
  
    <nav class="md-nav" aria-label="FAQ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choosing-between-decorator-and-context-manager" class="md-nav__link">
    Choosing between decorator and context manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integrating-exception-handling-with-sentryio" class="md-nav__link">
    Integrating exception handling with Sentry.io
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#legacy" class="md-nav__link">
    Legacy
  </a>
  
    <nav class="md-nav" aria-label="Legacy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migration-guide" class="md-nav__link">
    Migration guide
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-boto-configuration" class="md-nav__link">
    Customizing boto configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#suppressing-exceptions" class="md-nav__link">
    Suppressing exceptions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../typing/" class="md-nav__link">
        Typing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        Validation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../data_classes/" class="md-nav__link">
        Event Source Data Classes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../parser/" class="md-nav__link">
        Parser
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../idempotency/" class="md-nav__link">
        Idempotency
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../feature_flags/" class="md-nav__link">
        Feature flags
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../jmespath_functions/" class="md-nav__link">
        JMESPath Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/aws-cloudformation/custom-resource-helper" target="_blank" class="md-nav__link">
        CloudFormation Custom Resources
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    Key Features
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    Background
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting started
  </a>
  
    <nav class="md-nav" aria-label="Getting started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#required-resources" class="md-nav__link">
    Required resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-messages-from-sqs" class="md-nav__link">
    Processing messages from SQS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-messages-from-kinesis" class="md-nav__link">
    Processing messages from Kinesis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-messages-from-dynamodb" class="md-nav__link">
    Processing messages from DynamoDB
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#partial-failure-mechanics" class="md-nav__link">
    Partial failure mechanics
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    Advanced
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pydantic-integration" class="md-nav__link">
    Pydantic integration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#accessing-processed-messages" class="md-nav__link">
    Accessing processed messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#extending-batchprocessor" class="md-nav__link">
    Extending BatchProcessor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-your-own-partial-processor" class="md-nav__link">
    Create your own partial processor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#caveats" class="md-nav__link">
    Caveats
  </a>
  
    <nav class="md-nav" aria-label="Caveats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tracer-response-auto-capture-for-large-batch-sizes" class="md-nav__link">
    Tracer response auto-capture for large batch sizes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-your-code" class="md-nav__link">
    Testing your code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" class="md-nav__link">
    FAQ
  </a>
  
    <nav class="md-nav" aria-label="FAQ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#choosing-between-decorator-and-context-manager" class="md-nav__link">
    Choosing between decorator and context manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#integrating-exception-handling-with-sentryio" class="md-nav__link">
    Integrating exception handling with Sentry.io
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#legacy" class="md-nav__link">
    Legacy
  </a>
  
    <nav class="md-nav" aria-label="Legacy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#migration-guide" class="md-nav__link">
    Migration guide
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-boto-configuration" class="md-nav__link">
    Customizing boto configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#suppressing-exceptions" class="md-nav__link">
    Suppressing exceptions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/awslabs/aws-lambda-powertools-python/edit/develop/docs/utilities/batch.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>Batch Processing</h1>
                
                <p>The batch processing utility handles partial failures when processing batches from Amazon SQS, Amazon Kinesis Data Streams, and Amazon DynamoDB Streams.</p>
<h2 id="key-features">Key Features<a class="headerlink" href="#key-features" title="Permanent link">&para;</a></h2>
<ul>
<li>Reports batch item failures to reduce number of retries for a record upon errors</li>
<li>Simple interface to process each batch record</li>
<li>Integrates with <a href="../data_classes/" target="&quot;_blank">Event Source Data Classes</a> and <a href="../parser/" target="&quot;_blank">Parser (Pydantic)</a> for self-documenting record schema</li>
<li>Build your own batch processor by extending primitives</li>
</ul>
<h2 id="background">Background<a class="headerlink" href="#background" title="Permanent link">&para;</a></h2>
<p>When using SQS, Kinesis Data Streams, or DynamoDB Streams as a Lambda event source, your Lambda functions are triggered with a batch of messages.</p>
<p>If your function fails to process any message from the batch, the entire batch returns to your queue or stream. This same batch is then retried until either condition happens first: <strong>a)</strong> your Lambda function returns a successful response, <strong>b)</strong> record reaches maximum retry attempts, or <strong>c)</strong> when records expire.</p>
<p>With this utility, batch records are processed individually â€“ only messages that failed to be processed return to the queue or stream for a further retry. This works when two mechanisms are in place:</p>
<ol>
<li><code>ReportBatchItemFailures</code> is set in your SQS, Kinesis, or DynamoDB event source properties</li>
<li><a href="https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html#sqs-batchfailurereporting-syntax" target="_blank">A specific response</a> is returned so Lambda knows which records should not be deleted during partial responses</li>
</ol>
<details class="warning" open="open">
<summary>Warning: This utility lowers the chance of processing records more than once; it does not guarantee it</summary>
<p>We recommend implementing processing logic in an <a href="../idempotency/" target="_blank">idempotent manner</a> wherever possible.</p>
<p>You can find more details on how Lambda works with either <a href="https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html" target="_blank">SQS</a>, <a href="https://docs.aws.amazon.com/lambda/latest/dg/with-kinesis.html" target="_blank">Kinesis</a>, or <a href="https://docs.aws.amazon.com/lambda/latest/dg/with-ddb.html" target="_blank">DynamoDB</a> in the AWS Documentation.</p>
</details>
<h2 id="getting-started">Getting started<a class="headerlink" href="#getting-started" title="Permanent link">&para;</a></h2>
<p>Regardless whether you're using SQS, Kinesis Data Streams or DynamoDB Streams, you must configure your Lambda function event source to use <code>`ReportBatchItemFailures</code>.</p>
<p>You do not need any additional IAM permissions to use this utility, except for what each event source requires.</p>
<h3 id="required-resources">Required resources<a class="headerlink" href="#required-resources" title="Permanent link">&para;</a></h3>
<p>The remaining sections of the documentation will rely on these samples. For completeness, this demonstrates IAM permissions and Dead Letter Queue where batch records will be sent after 2 retries were attempted.</p>
<div class="tabbed-set" data-tabs="1:3"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">SQS</label><div class="tabbed-content">
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">template.yaml</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">AWSTemplateFormatVersion</span><span class="p">:</span> <span class="s">&#39;2010-09-09&#39;</span>
<span class="nt">Transform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::Serverless-2016-10-31</span>
<span class="nt">Description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">partial batch response sample</span>

<span class="nt">Globals</span><span class="p">:</span>
    <span class="nt">Function</span><span class="p">:</span>
        <span class="nt">Timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">MemorySize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">256</span>
        <span class="nt">Runtime</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python3.9</span>
        <span class="nt">Tracing</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Active</span>
        <span class="nt">Environment</span><span class="p">:</span>
            <span class="nt">Variables</span><span class="p">:</span>
                <span class="nt">LOG_LEVEL</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">INFO</span>
                <span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hello</span>

<span class="nt">Resources</span><span class="p">:</span>
    <span class="nt">HelloWorldFunction</span><span class="p">:</span>
        <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
        <span class="nt">Properties</span><span class="p">:</span>
            <span class="nt">Handler</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">app.lambda_handler</span>
            <span class="nt">CodeUri</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hello_world</span>
            <span class="nt">Policies</span><span class="p">:</span>
                <span class="p p-Indicator">-</span> <span class="nt">SQSPollerPolicy</span><span class="p">:</span>
                    <span class="nt">QueueName</span><span class="p">:</span> <span class="kt">!GetAtt</span> <span class="l l-Scalar l-Scalar-Plain">SampleQueue.QueueName</span>
            <span class="nt">Events</span><span class="p">:</span>
                <span class="nt">Batch</span><span class="p">:</span>
                    <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">SQS</span>
                    <span class="nt">Properties</span><span class="p">:</span>
                        <span class="nt">Queue</span><span class="p">:</span> <span class="kt">!GetAtt</span> <span class="l l-Scalar l-Scalar-Plain">SampleQueue.Arn</span>
                        <span class="nt">FunctionResponseTypes</span><span class="p">:</span>
<span class="hll">                            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReportBatchItemFailures</span>
</span><span class="hll">
</span>    <span class="nt">SampleDLQ</span><span class="p">:</span>
        <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::SQS::Queue</span>

    <span class="nt">SampleQueue</span><span class="p">:</span>
        <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::SQS::Queue</span>
        <span class="nt">Properties</span><span class="p">:</span>
            <span class="nt">VisibilityTimeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">30</span> <span class="c1"># Fn timeout * 6</span>
            <span class="nt">RedrivePolicy</span><span class="p">:</span>
                <span class="nt">maxReceiveCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
                <span class="nt">deadLetterTargetArn</span><span class="p">:</span> <span class="kt">!GetAtt</span> <span class="l l-Scalar l-Scalar-Plain">SampleDLQ.Arn</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">Kinesis Data Streams</label><div class="tabbed-content">
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">template.yaml</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">AWSTemplateFormatVersion</span><span class="p">:</span> <span class="s">&#39;2010-09-09&#39;</span>
<span class="nt">Transform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::Serverless-2016-10-31</span>
<span class="nt">Description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">partial batch response sample</span>

<span class="nt">Globals</span><span class="p">:</span>
    <span class="nt">Function</span><span class="p">:</span>
        <span class="nt">Timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">MemorySize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">256</span>
        <span class="nt">Runtime</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python3.9</span>
        <span class="nt">Tracing</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Active</span>
        <span class="nt">Environment</span><span class="p">:</span>
            <span class="nt">Variables</span><span class="p">:</span>
                <span class="nt">LOG_LEVEL</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">INFO</span>
                <span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hello</span>

<span class="nt">Resources</span><span class="p">:</span>
    <span class="nt">HelloWorldFunction</span><span class="p">:</span>
        <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
        <span class="nt">Properties</span><span class="p">:</span>
            <span class="nt">Handler</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">app.lambda_handler</span>
            <span class="nt">CodeUri</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hello_world</span>
            <span class="nt">Policies</span><span class="p">:</span>
                <span class="c1"># Lambda Destinations require additional permissions</span>
                <span class="c1"># to send failure records to DLQ from Kinesis/DynamoDB</span>
                <span class="p p-Indicator">-</span> <span class="nt">Version</span><span class="p">:</span> <span class="s">&quot;2012-10-17&quot;</span>
                  <span class="nt">Statement</span><span class="p">:</span>
                    <span class="nt">Effect</span><span class="p">:</span> <span class="s">&quot;Allow&quot;</span>
                    <span class="nt">Action</span><span class="p">:</span>
                        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sqs:GetQueueAttributes</span>
                        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sqs:GetQueueUrl</span>
                        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sqs:SendMessage</span>
                    <span class="nt">Resource</span><span class="p">:</span> <span class="kt">!GetAtt</span> <span class="l l-Scalar l-Scalar-Plain">SampleDLQ.Arn</span>
            <span class="nt">Events</span><span class="p">:</span>
                <span class="nt">KinesisStream</span><span class="p">:</span>
                    <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Kinesis</span>
                    <span class="nt">Properties</span><span class="p">:</span>
                        <span class="nt">Stream</span><span class="p">:</span> <span class="kt">!GetAtt</span> <span class="l l-Scalar l-Scalar-Plain">SampleStream.Arn</span>
                        <span class="nt">BatchSize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
                        <span class="nt">StartingPosition</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">LATEST</span>
                        <span class="nt">MaximumRetryAttempts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
                        <span class="nt">DestinationConfig</span><span class="p">:</span>
                            <span class="nt">OnFailure</span><span class="p">:</span>
                                <span class="nt">Destination</span><span class="p">:</span> <span class="kt">!GetAtt</span> <span class="l l-Scalar l-Scalar-Plain">SampleDLQ.Arn</span>
<span class="hll">                        <span class="nt">FunctionResponseTypes</span><span class="p">:</span>
</span><span class="hll">                            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReportBatchItemFailures</span>
</span>
    <span class="nt">SampleDLQ</span><span class="p">:</span>
        <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::SQS::Queue</span>

    <span class="nt">SampleStream</span><span class="p">:</span>
        <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::Kinesis::Stream</span>
        <span class="nt">Properties</span><span class="p">:</span>
            <span class="nt">ShardCount</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><label for="__tabbed_1_3">DynamoDB Streams</label><div class="tabbed-content">
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">template.yaml</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nt">AWSTemplateFormatVersion</span><span class="p">:</span> <span class="s">&#39;2010-09-09&#39;</span>
<span class="nt">Transform</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::Serverless-2016-10-31</span>
<span class="nt">Description</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">partial batch response sample</span>

<span class="nt">Globals</span><span class="p">:</span>
    <span class="nt">Function</span><span class="p">:</span>
        <span class="nt">Timeout</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
        <span class="nt">MemorySize</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">256</span>
        <span class="nt">Runtime</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">python3.9</span>
        <span class="nt">Tracing</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Active</span>
        <span class="nt">Environment</span><span class="p">:</span>
            <span class="nt">Variables</span><span class="p">:</span>
                <span class="nt">LOG_LEVEL</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">INFO</span>
                <span class="nt">POWERTOOLS_SERVICE_NAME</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hello</span>

<span class="nt">Resources</span><span class="p">:</span>
    <span class="nt">HelloWorldFunction</span><span class="p">:</span>
        <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
        <span class="nt">Properties</span><span class="p">:</span>
            <span class="nt">Handler</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">app.lambda_handler</span>
            <span class="nt">CodeUri</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hello_world</span>
            <span class="nt">Policies</span><span class="p">:</span>
                <span class="c1"># Lambda Destinations require additional permissions</span>
                <span class="c1"># to send failure records from Kinesis/DynamoDB</span>
                <span class="p p-Indicator">-</span> <span class="nt">Version</span><span class="p">:</span> <span class="s">&quot;2012-10-17&quot;</span>
                  <span class="nt">Statement</span><span class="p">:</span>
                    <span class="nt">Effect</span><span class="p">:</span> <span class="s">&quot;Allow&quot;</span>
                    <span class="nt">Action</span><span class="p">:</span>
                        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sqs:GetQueueAttributes</span>
                        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sqs:GetQueueUrl</span>
                        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">sqs:SendMessage</span>
                    <span class="nt">Resource</span><span class="p">:</span> <span class="kt">!GetAtt</span> <span class="l l-Scalar l-Scalar-Plain">SampleDLQ.Arn</span>
            <span class="nt">Events</span><span class="p">:</span>
                <span class="nt">DynamoDBStream</span><span class="p">:</span>
                    <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">DynamoDB</span>
                    <span class="nt">Properties</span><span class="p">:</span>
                        <span class="nt">Stream</span><span class="p">:</span> <span class="kt">!GetAtt</span> <span class="l l-Scalar l-Scalar-Plain">SampleTable.StreamArn</span>
                        <span class="nt">StartingPosition</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">LATEST</span>
                        <span class="nt">MaximumRetryAttempts</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
                        <span class="nt">DestinationConfig</span><span class="p">:</span>
                            <span class="nt">OnFailure</span><span class="p">:</span>
                                <span class="nt">Destination</span><span class="p">:</span> <span class="kt">!GetAtt</span> <span class="l l-Scalar l-Scalar-Plain">SampleDLQ.Arn</span>
<span class="hll">                        <span class="nt">FunctionResponseTypes</span><span class="p">:</span>
</span><span class="hll">                            <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReportBatchItemFailures</span>
</span>
    <span class="nt">SampleDLQ</span><span class="p">:</span>
        <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::SQS::Queue</span>

    <span class="nt">SampleTable</span><span class="p">:</span>
        <span class="nt">Type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">AWS::DynamoDB::Table</span>
        <span class="nt">Properties</span><span class="p">:</span>
            <span class="nt">BillingMode</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PAY_PER_REQUEST</span>
            <span class="nt">AttributeDefinitions</span><span class="p">:</span>
                <span class="p p-Indicator">-</span> <span class="nt">AttributeName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pk</span>
                  <span class="nt">AttributeType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">S</span>
                <span class="p p-Indicator">-</span> <span class="nt">AttributeName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sk</span>
                  <span class="nt">AttributeType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">S</span>
            <span class="nt">KeySchema</span><span class="p">:</span>
                <span class="p p-Indicator">-</span> <span class="nt">AttributeName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">pk</span>
                  <span class="nt">KeyType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">HASH</span>
                <span class="p p-Indicator">-</span> <span class="nt">AttributeName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">sk</span>
                  <span class="nt">KeyType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RANGE</span>
            <span class="nt">SSESpecification</span><span class="p">:</span>
                <span class="nt">SSEEnabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
            <span class="nt">StreamSpecification</span><span class="p">:</span>
                <span class="nt">StreamViewType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">NEW_AND_OLD_IMAGES</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<h3 id="processing-messages-from-sqs">Processing messages from SQS<a class="headerlink" href="#processing-messages-from-sqs" title="Permanent link">&para;</a></h3>
<p>Processing batches from SQS works in four stages:</p>
<ol>
<li>Instantiate <strong><code>BatchProcessor</code></strong> and choose <strong><code>EventType.SQS</code></strong> for the event type</li>
<li>Define your function to handle each batch record, and use <a href="../data_classes/#sqs" target="_blank"><code>SQSRecord</code></a> type annotation for autocompletion</li>
<li>Use either <strong><code>batch_processor</code></strong> decorator or your instantiated processor as a context manager to kick off processing</li>
<li>Return the appropriate response contract to Lambda via <strong><code>.response()</code></strong> processor method</li>
</ol>
<details class="info" open="open">
<summary>Info</summary>
<p>This code example optionally uses Tracer and Logger for completion.</p>
</details>
<div class="tabbed-set" data-tabs="2:4"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">As a decorator</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.sqs_event</span> <span class="kn">import</span> <span class="n">SQSRecord</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="hll"><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">SQS</span><span class="p">)</span>
</span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="hll"><span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">SQSRecord</span><span class="p">):</span>
</span>    <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">body</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="o">...</span>

<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="hll"><span class="nd">@batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
<span class="hll">    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</span></code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><label for="__tabbed_2_2">As a context manager</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.sqs_event</span> <span class="kn">import</span> <span class="n">SQSRecord</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="hll"><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">SQS</span><span class="p">)</span>
</span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="hll"><span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">SQSRecord</span><span class="p">):</span>
</span>    <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">body</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="o">...</span>

<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
<span class="hll">    <span class="n">batch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;Records&quot;</span><span class="p">]</span>
</span><span class="hll">    <span class="k">with</span> <span class="n">processor</span><span class="p">(</span><span class="n">records</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">):</span>
</span><span class="hll">        <span class="n">processed_messages</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span> <span class="c1"># kick off processing, return list[tuple]</span>
</span>
<span class="hll">    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</span></code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_2_3" name="__tabbed_2" type="radio" /><label for="__tabbed_2_3">Sample response</label><div class="tabbed-content">
<p>The second record failed to be processed, therefore the processor added its message ID in the response.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="s1">&#39;batchItemFailures&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;itemIdentifier&#39;</span><span class="p">:</span> <span class="s1">&#39;244fc6b4-87a3-44ab-83d2-361172410c3a&#39;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_2_4" name="__tabbed_2" type="radio" /><label for="__tabbed_2_4">Sample event</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;Records&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;messageId&quot;</span><span class="p">:</span> <span class="s2">&quot;059f36b4-87a3-44ab-83d2-661975830a7d&quot;</span><span class="p">,</span>
            <span class="nt">&quot;receiptHandle&quot;</span><span class="p">:</span> <span class="s2">&quot;AQEBwJnKyrHigUMZj6rYigCgxlaS3SLy0a&quot;</span><span class="p">,</span>
            <span class="nt">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;{\&quot;Message\&quot;: \&quot;success\&quot;}&quot;</span><span class="p">,</span>
            <span class="nt">&quot;attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ApproximateReceiveCount&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SentTimestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;1545082649183&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SenderId&quot;</span><span class="p">:</span> <span class="s2">&quot;AIDAIENQZJOLO23YVJ4VO&quot;</span><span class="p">,</span>
                <span class="nt">&quot;ApproximateFirstReceiveTimestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;1545082649185&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;messageAttributes&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="nt">&quot;md5OfBody&quot;</span><span class="p">:</span> <span class="s2">&quot;e4e68fb7bd0e697a0ae8f1bb342846b3&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSource&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:sqs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSourceARN&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:sqs:us-east-2: 123456789012:my-queue&quot;</span><span class="p">,</span>
            <span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-1&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;messageId&quot;</span><span class="p">:</span> <span class="s2">&quot;244fc6b4-87a3-44ab-83d2-361172410c3a&quot;</span><span class="p">,</span>
            <span class="nt">&quot;receiptHandle&quot;</span><span class="p">:</span> <span class="s2">&quot;AQEBwJnKyrHigUMZj6rYigCgxlaS3SLy0a&quot;</span><span class="p">,</span>
            <span class="nt">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;SGVsbG8sIHRoaXMgaXMgYSB0ZXN0Lg==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ApproximateReceiveCount&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SentTimestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;1545082649183&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SenderId&quot;</span><span class="p">:</span> <span class="s2">&quot;AIDAIENQZJOLO23YVJ4VO&quot;</span><span class="p">,</span>
                <span class="nt">&quot;ApproximateFirstReceiveTimestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;1545082649185&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;messageAttributes&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="nt">&quot;md5OfBody&quot;</span><span class="p">:</span> <span class="s2">&quot;e4e68fb7bd0e697a0ae8f1bb342846b3&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSource&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:sqs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSourceARN&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:sqs:us-east-2: 123456789012:my-queue&quot;</span><span class="p">,</span>
            <span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-1&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<h3 id="processing-messages-from-kinesis">Processing messages from Kinesis<a class="headerlink" href="#processing-messages-from-kinesis" title="Permanent link">&para;</a></h3>
<p>Processing batches from Kinesis works in four stages:</p>
<ol>
<li>Instantiate <strong><code>BatchProcessor</code></strong> and choose <strong><code>EventType.KinesisDataStreams</code></strong> for the event type</li>
<li>Define your function to handle each batch record, and use <a href="../data_classes/#kinesis-streams" target="_blank"><code>KinesisStreamRecord</code></a> type annotation for autocompletion</li>
<li>Use either <strong><code>batch_processor</code></strong> decorator or your instantiated processor as a context manager to kick off processing</li>
<li>Return the appropriate response contract to Lambda via <strong><code>.response()</code></strong> processor method</li>
</ol>
<details class="info" open="open">
<summary>Info</summary>
<p>This code example optionally uses Tracer and Logger for completion.</p>
</details>
<div class="tabbed-set" data-tabs="3:4"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><label for="__tabbed_3_1">As a decorator</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.kinesis_stream_event</span> <span class="kn">import</span> <span class="n">KinesisStreamRecord</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="hll"><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">KinesisDataStreams</span><span class="p">)</span>
</span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="hll"><span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">KinesisStreamRecord</span><span class="p">):</span>
</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">kinesis</span><span class="o">.</span><span class="n">data_as_text</span><span class="p">)</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">kinesis</span><span class="o">.</span><span class="n">data_as_json</span><span class="p">()</span>
    <span class="o">...</span>

<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="hll"><span class="nd">@batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
<span class="hll">    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</span></code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><label for="__tabbed_3_2">As a context manager</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.kinesis_stream_event</span> <span class="kn">import</span> <span class="n">KinesisStreamRecord</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="hll"><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">KinesisDataStreams</span><span class="p">)</span>
</span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="hll"><span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">KinesisStreamRecord</span><span class="p">):</span>
</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">kinesis</span><span class="o">.</span><span class="n">data_as_text</span><span class="p">)</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">kinesis</span><span class="o">.</span><span class="n">data_as_json</span><span class="p">()</span>
    <span class="o">...</span>

<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
<span class="hll">    <span class="n">batch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;Records&quot;</span><span class="p">]</span>
</span><span class="hll">    <span class="k">with</span> <span class="n">processor</span><span class="p">(</span><span class="n">records</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">):</span>
</span><span class="hll">        <span class="n">processed_messages</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span> <span class="c1"># kick off processing, return list[tuple]</span>
</span>
<span class="hll">    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</span></code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_3_3" name="__tabbed_3" type="radio" /><label for="__tabbed_3_3">Sample response</label><div class="tabbed-content">
<p>The second record failed to be processed, therefore the processor added its sequence number in the response.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="s1">&#39;batchItemFailures&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;itemIdentifier&#39;</span><span class="p">:</span> <span class="s1">&#39;6006958808509702859251049540584488075644979031228738&#39;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_3_4" name="__tabbed_3" type="radio" /><label for="__tabbed_3_4">Sample event</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;Records&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;kinesis&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;kinesisSchemaVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
                <span class="nt">&quot;partitionKey&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="nt">&quot;sequenceNumber&quot;</span><span class="p">:</span> <span class="s2">&quot;4107859083838847772757075850904226111829882106684065&quot;</span><span class="p">,</span>
                <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;eyJNZXNzYWdlIjogInN1Y2Nlc3MifQ==&quot;</span><span class="p">,</span>
                <span class="nt">&quot;approximateArrivalTimestamp&quot;</span><span class="p">:</span> <span class="mf">1545084650.987</span>
            <span class="p">},</span>
            <span class="nt">&quot;eventSource&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:kinesis&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventID&quot;</span><span class="p">:</span> <span class="s2">&quot;shardId-000000000006:4107859083838847772757075850904226111829882106684065&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventName&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:kinesis:record&quot;</span><span class="p">,</span>
            <span class="nt">&quot;invokeIdentityArn&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iam::123456789012:role/lambda-role&quot;</span><span class="p">,</span>
            <span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-2&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSourceARN&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:kinesis:us-east-2:123456789012:stream/lambda-stream&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;kinesis&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;kinesisSchemaVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
                <span class="nt">&quot;partitionKey&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="nt">&quot;sequenceNumber&quot;</span><span class="p">:</span> <span class="s2">&quot;6006958808509702859251049540584488075644979031228738&quot;</span><span class="p">,</span>
                <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;c3VjY2Vzcw==&quot;</span><span class="p">,</span>
                <span class="nt">&quot;approximateArrivalTimestamp&quot;</span><span class="p">:</span> <span class="mf">1545084650.987</span>
            <span class="p">},</span>
            <span class="nt">&quot;eventSource&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:kinesis&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventID&quot;</span><span class="p">:</span> <span class="s2">&quot;shardId-000000000006:6006958808509702859251049540584488075644979031228738&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventName&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:kinesis:record&quot;</span><span class="p">,</span>
            <span class="nt">&quot;invokeIdentityArn&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:iam::123456789012:role/lambda-role&quot;</span><span class="p">,</span>
            <span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-2&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSourceARN&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:kinesis:us-east-2:123456789012:stream/lambda-stream&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<h3 id="processing-messages-from-dynamodb">Processing messages from DynamoDB<a class="headerlink" href="#processing-messages-from-dynamodb" title="Permanent link">&para;</a></h3>
<p>Processing batches from Kinesis works in four stages:</p>
<ol>
<li>Instantiate <strong><code>BatchProcessor</code></strong> and choose <strong><code>EventType.DynamoDBStreams</code></strong> for the event type</li>
<li>Define your function to handle each batch record, and use <a href="../data_classes/#dynamodb-streams" target="_blank"><code>DynamoDBRecord</code></a> type annotation for autocompletion</li>
<li>Use either <strong><code>batch_processor</code></strong> decorator or your instantiated processor as a context manager to kick off processing</li>
<li>Return the appropriate response contract to Lambda via <strong><code>.response()</code></strong> processor method</li>
</ol>
<details class="info" open="open">
<summary>Info</summary>
<p>This code example optionally uses Tracer and Logger for completion.</p>
</details>
<div class="tabbed-set" data-tabs="4:4"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><label for="__tabbed_4_1">As a decorator</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.dynamo_db_stream_event</span> <span class="kn">import</span> <span class="n">DynamoDBRecord</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="hll"><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">DynamoDBStreams</span><span class="p">)</span>
</span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="hll"><span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">DynamoDBRecord</span><span class="p">):</span>
</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">new_image</span><span class="p">)</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">new_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Message&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_value</span><span class="p">)</span>
    <span class="c1"># alternatively:</span>
    <span class="c1"># changes: Dict[str, dynamo_db_stream_event.AttributeValue] = record.dynamodb.new_image</span>
    <span class="c1"># payload = change.get(&quot;Message&quot;).raw_event -&gt; {&quot;S&quot;: &quot;&lt;payload&gt;&quot;}</span>
    <span class="o">...</span>

<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="hll"><span class="nd">@batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
<span class="hll">    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</span></code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><label for="__tabbed_4_2">As a context manager</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.dynamo_db_stream_event</span> <span class="kn">import</span> <span class="n">DynamoDBRecord</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="hll"><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">DynamoDBStreams</span><span class="p">)</span>
</span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="hll"><span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">DynamoDBRecord</span><span class="p">):</span>
</span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">new_image</span><span class="p">)</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">new_image</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;item&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">s_value</span><span class="p">)</span>
    <span class="c1"># alternatively:</span>
    <span class="c1"># changes: Dict[str, dynamo_db_stream_event.AttributeValue] = record.dynamodb.new_image</span>
    <span class="c1"># payload = change.get(&quot;Message&quot;).raw_event -&gt; {&quot;S&quot;: &quot;&lt;payload&gt;&quot;}</span>
    <span class="o">...</span>

<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
<span class="hll">    <span class="n">batch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;Records&quot;</span><span class="p">]</span>
</span><span class="hll">    <span class="k">with</span> <span class="n">processor</span><span class="p">(</span><span class="n">records</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">):</span>
</span><span class="hll">        <span class="n">processed_messages</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span> <span class="c1"># kick off processing, return list[tuple]</span>
</span>
<span class="hll">    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</span></code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_4_3" name="__tabbed_4" type="radio" /><label for="__tabbed_4_3">Sample response</label><div class="tabbed-content">
<p>The second record failed to be processed, therefore the processor added its sequence number in the response.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="s1">&#39;batchItemFailures&#39;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s1">&#39;itemIdentifier&#39;</span><span class="p">:</span> <span class="s1">&#39;8640712661&#39;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_4_4" name="__tabbed_4" type="radio" /><label for="__tabbed_4_4">Sample event</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;Records&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;eventID&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
            <span class="nt">&quot;dynamodb&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;Keys&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;Id&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="nt">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;101&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&quot;NewImage&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;Message&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="nt">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;failure&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&quot;StreamViewType&quot;</span><span class="p">:</span> <span class="s2">&quot;NEW_AND_OLD_IMAGES&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SequenceNumber&quot;</span><span class="p">:</span> <span class="s2">&quot;3275880929&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SizeBytes&quot;</span><span class="p">:</span> <span class="mi">26</span>
            <span class="p">},</span>
            <span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span> <span class="s2">&quot;us-west-2&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventName&quot;</span><span class="p">:</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSourceARN&quot;</span><span class="p">:</span> <span class="s2">&quot;eventsource_arn&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSource&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:dynamodb&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;eventID&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
            <span class="nt">&quot;dynamodb&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;Keys&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;Id&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="nt">&quot;N&quot;</span><span class="p">:</span> <span class="s2">&quot;101&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&quot;NewImage&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;SomethingElse&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="nt">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span>
                    <span class="p">}</span>
                <span class="p">},</span>
                <span class="nt">&quot;StreamViewType&quot;</span><span class="p">:</span> <span class="s2">&quot;NEW_AND_OLD_IMAGES&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SequenceNumber&quot;</span><span class="p">:</span> <span class="s2">&quot;8640712661&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SizeBytes&quot;</span><span class="p">:</span> <span class="mi">26</span>
            <span class="p">},</span>
            <span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span> <span class="s2">&quot;us-west-2&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventName&quot;</span><span class="p">:</span> <span class="s2">&quot;INSERT&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSourceARN&quot;</span><span class="p">:</span> <span class="s2">&quot;eventsource_arn&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSource&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:dynamodb&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<h3 id="partial-failure-mechanics">Partial failure mechanics<a class="headerlink" href="#partial-failure-mechanics" title="Permanent link">&para;</a></h3>
<p>All records in the batch will be passed to this handler for processing, even if exceptions are thrown - Here's the behaviour after completing the batch:</p>
<ul>
<li><strong>All records successfully processed</strong>. We will return an empty list of item failures <code>{'batchItemFailures': []}</code></li>
<li><strong>Partial success with some exceptions</strong>. We will return a list of all item IDs/sequence numbers that failed processing</li>
<li><strong>All records failed to be processed</strong>. We will raise <code>BatchProcessingError</code> exception with a list of all exceptions raised when processing</li>
</ul>
<details class="warning" open="open">
<summary>Warning</summary>
<p>You will not have access to the <strong>processed messages</strong> within the Lambda Handler; use context manager for that.</p>
<p>All processing logic will and should be performed by the <code>record_handler</code> function.</p>
</details>
<h2 id="advanced">Advanced<a class="headerlink" href="#advanced" title="Permanent link">&para;</a></h2>
<h3 id="pydantic-integration">Pydantic integration<a class="headerlink" href="#pydantic-integration" title="Permanent link">&para;</a></h3>
<p>You can bring your own Pydantic models via <strong><code>model</code></strong> parameter when inheriting from <strong><code>SqsRecordModel</code></strong>, <strong><code>KinesisDataStreamRecord</code></strong>, or <strong><code>DynamoDBStreamRecordModel</code></strong></p>
<p>Inheritance is importance because we need to access message IDs and sequence numbers from these records in the event of failure. Mypy is fully integrated with this utility, so it should identify whether you're passing the incorrect Model.</p>
<div class="tabbed-set" data-tabs="5:3"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><label for="__tabbed_5_1">SQS</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.parser.models</span> <span class="kn">import</span> <span class="n">SqsRecordModel</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="hll"><span class="k">class</span> <span class="nc">Order</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span class="hll">    <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span>
</span>
<span class="hll"><span class="k">class</span> <span class="nc">OrderSqsRecord</span><span class="p">(</span><span class="n">SqsRecordModel</span><span class="p">):</span>
</span><span class="hll">    <span class="n">body</span><span class="p">:</span> <span class="n">Order</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># auto transform json string</span>
</span><span class="hll">    <span class="c1"># so Pydantic can auto-initialize nested Order model</span>
</span><span class="hll">    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">transform_body_to_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span>
<span class="hll"><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">SQS</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">OrderSqsRecord</span><span class="p">)</span>
</span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="hll"><span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">OrderSqsRecord</span><span class="p">):</span>
</span>    <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">item</span>

<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="nd">@batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><label for="__tabbed_5_2">Kinesis Data Streams</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.parser.models</span> <span class="kn">import</span> <span class="n">KinesisDataStreamRecord</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="hll"><span class="k">class</span> <span class="nc">Order</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span class="hll">    <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span>
</span>
<span class="hll"><span class="k">class</span> <span class="nc">OrderKinesisPayloadRecord</span><span class="p">(</span><span class="n">KinesisDataStreamRecordPayload</span><span class="p">):</span>
</span><span class="hll">    <span class="n">data</span><span class="p">:</span> <span class="n">Order</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># auto transform json string</span>
</span><span class="hll">    <span class="c1"># so Pydantic can auto-initialize nested Order model</span>
</span><span class="hll">    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">transform_message_to_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span class="hll">        <span class="c1"># Powertools KinesisDataStreamRecordModel already decodes b64 to str here</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span>
<span class="hll"><span class="k">class</span> <span class="nc">OrderKinesisRecord</span><span class="p">(</span><span class="n">KinesisDataStreamRecordModel</span><span class="p">):</span>
</span><span class="hll">    <span class="n">kinesis</span><span class="p">:</span> <span class="n">OrderKinesisPayloadRecord</span>
</span>

<span class="hll"><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">KinesisDataStreams</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">OrderKinesisRecord</span><span class="p">)</span>
</span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="hll"><span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">OrderKinesisRecord</span><span class="p">):</span>
</span>    <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">kinesis</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">item</span>


<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="nd">@batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_5_3" name="__tabbed_5" type="radio" /><label for="__tabbed_5_3">DynamoDB Streams</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.parser.models</span> <span class="kn">import</span> <span class="n">DynamoDBStreamRecordModel</span>
</span><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="hll"><span class="k">class</span> <span class="nc">Order</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span class="hll">    <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span>
</span>
<span class="hll"><span class="k">class</span> <span class="nc">OrderDynamoDB</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span><span class="hll">    <span class="n">Message</span><span class="p">:</span> <span class="n">Order</span>
</span><span class="hll">
</span><span class="hll">    <span class="c1"># auto transform json string</span>
</span><span class="hll">    <span class="c1"># so Pydantic can auto-initialize nested Order model</span>
</span><span class="hll">    <span class="nd">@validator</span><span class="p">(</span><span class="s2">&quot;Message&quot;</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">transform_message_to_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">]):</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">])</span>
</span>
<span class="hll"><span class="k">class</span> <span class="nc">OrderDynamoDBChangeRecord</span><span class="p">(</span><span class="n">DynamoDBStreamChangedRecordModel</span><span class="p">):</span>
</span><span class="hll">    <span class="n">NewImage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OrderDynamoDB</span><span class="p">]</span>
</span><span class="hll">    <span class="n">OldImage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OrderDynamoDB</span><span class="p">]</span>
</span>
<span class="hll"><span class="k">class</span> <span class="nc">OrderDynamoDBRecord</span><span class="p">(</span><span class="n">DynamoDBStreamRecordModel</span><span class="p">):</span>
</span><span class="hll">    <span class="n">dynamodb</span><span class="p">:</span> <span class="n">OrderDynamoDBChangeRecord</span>
</span>

<span class="hll"><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">DynamoDBStreams</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">OrderKinesisRecord</span><span class="p">)</span>
</span><span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="hll"><span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">OrderDynamoDBRecord</span><span class="p">):</span>
</span>    <span class="k">return</span> <span class="n">record</span><span class="o">.</span><span class="n">dynamodb</span><span class="o">.</span><span class="n">NewImage</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">item</span>


<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="nd">@batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<h3 id="accessing-processed-messages">Accessing processed messages<a class="headerlink" href="#accessing-processed-messages" title="Permanent link">&para;</a></h3>
<p>Use the context manager to access a list of all returned values from your <code>record_handler</code> function.</p>
<ul>
<li><strong>When successful</strong>. We will include a tuple with <code>success</code>, the result of <code>record_handler</code>, and the batch record</li>
<li><strong>When failed</strong>. We will include a tuple with <code>fail</code>, exception as a string, and the batch record</li>
</ul>
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">Accessing processed messages via context manager</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="p">(</span><span class="n">BatchProcessor</span><span class="p">,</span>
                                                   <span class="n">EventType</span><span class="p">,</span>
                                                   <span class="n">FailureResponse</span><span class="p">,</span>
                                                   <span class="n">SuccessResponse</span><span class="p">,</span>
                                                   <span class="n">batch_processor</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.sqs_event</span> <span class="kn">import</span> <span class="n">SQSRecord</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">SQS</span><span class="p">)</span>
<span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">SQSRecord</span><span class="p">):</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">body</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="o">...</span>

<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="n">batch</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;Records&quot;</span><span class="p">]</span>
<span class="hll">    <span class="k">with</span> <span class="n">processor</span><span class="p">(</span><span class="n">records</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">):</span>
</span><span class="hll">        <span class="n">processed_messages</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">SuccessResponse</span><span class="p">,</span> <span class="n">FailureResponse</span><span class="p">]]</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">processed_messages</span><span class="p">:</span>
</span><span class="hll">        <span class="n">status</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;fail&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="hll">        <span class="n">result</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class="hll">        <span class="n">record</span><span class="p">:</span> <span class="n">SQSRecord</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span class="hll">
</span>
    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<h3 id="extending-batchprocessor">Extending BatchProcessor<a class="headerlink" href="#extending-batchprocessor" title="Permanent link">&para;</a></h3>
<p>You might want to bring custom logic to the existing <code>BatchProcessor</code> to slightly override how we handle successes and failures.</p>
<p>For these scenarios, you can subclass <code>BatchProcessor</code> and quickly override <code>success_handler</code> and <code>failure_handler</code> methods:</p>
<ul>
<li><strong><code>success_handler()</code></strong> â€“ Keeps track of successful batch records</li>
<li><strong><code>failure_handler()</code></strong> â€“ Keeps track of failed batch records</li>
</ul>
<details class="example" open="open">
<summary>Example</summary>
<p>Let's suppose you'd like to add a metric named <code>BatchRecordFailures</code> for each batch record that failed processing</p>
</details>
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">Extending failure handling mechanism in BatchProcessor</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.metrics</span> <span class="kn">import</span> <span class="n">MetricUnit</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">batch_processor</span><span class="p">,</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">ExceptionInfo</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">FailureResponse</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.sqs_event</span> <span class="kn">import</span> <span class="n">SQSRecord</span>


<span class="k">class</span> <span class="nc">MyProcessor</span><span class="p">(</span><span class="n">BatchProcessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">failure_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">:</span> <span class="n">SQSRecord</span><span class="p">,</span> <span class="n">exception</span><span class="p">:</span> <span class="n">ExceptionInfo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FailureResponse</span><span class="p">:</span>
        <span class="n">metrics</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;BatchRecordFailures&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="n">MetricUnit</span><span class="o">.</span><span class="n">Count</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">failure_handler</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>

<span class="n">processor</span> <span class="o">=</span> <span class="n">MyProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">SQS</span><span class="p">)</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">Metrics</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">SQSRecord</span><span class="p">):</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">body</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="o">...</span>

<span class="nd">@metrics</span><span class="o">.</span><span class="n">log_metrics</span><span class="p">(</span><span class="n">capture_cold_start_metric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<h3 id="create-your-own-partial-processor">Create your own partial processor<a class="headerlink" href="#create-your-own-partial-processor" title="Permanent link">&para;</a></h3>
<p>You can create your own partial batch processor from scratch by inheriting the <code>BasePartialProcessor</code> class, and implementing <code>_prepare()</code>, <code>_clean()</code> and <code>_process_record()</code>.</p>
<ul>
<li><strong><code>_process_record()</code></strong> â€“ handles all processing logic for each individual message of a batch, including calling the <code>record_handler</code> (self.handler)</li>
<li><strong><code>_prepare()</code></strong> â€“ called once as part of the processor initialization</li>
<li><strong><code>clean()</code></strong> â€“ teardown logic called once after <code>_process_record</code> completes</li>
</ul>
<p>You can then use this class as a context manager, or pass it to <code>batch_processor</code> to use as a decorator on your Lambda handler function.</p>
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">Creating a custom batch processor</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>

<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BasePartialProcessor</span><span class="p">,</span> <span class="n">batch_processor</span>
</span><span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">table_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TABLE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;table_not_found&quot;</span><span class="p">)</span>

<span class="hll"><span class="k">class</span> <span class="nc">MyPartialProcessor</span><span class="p">(</span><span class="n">BasePartialProcessor</span><span class="p">):</span>
</span>    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process a record and stores successful results at a Amazon DynamoDB Table</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    table_name: str</span>
<span class="sd">        DynamoDB table name to write results to</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_name</span> <span class="o">=</span> <span class="n">table_name</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

<span class="hll">    <span class="k">def</span> <span class="nf">_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span>        <span class="c1"># It&#39;s called once, *before* processing</span>
        <span class="c1"># Creates table resource and clean previous results</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddb_table</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">success_messages</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="hll">    <span class="k">def</span> <span class="nf">_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span>        <span class="c1"># It&#39;s called once, *after* closing processing all records (closing the context manager)</span>
        <span class="c1"># Here we&#39;re sending, at once, all successful messages to a ddb table</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddb_table</span><span class="o">.</span><span class="n">batch_writer</span><span class="p">()</span> <span class="k">as</span> <span class="n">batch</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_messages</span><span class="p">:</span>
                <span class="n">batch</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">Item</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

<span class="hll">    <span class="k">def</span> <span class="nf">_process_record</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
</span>        <span class="c1"># It handles how your record is processed</span>
        <span class="c1"># Here we&#39;re keeping the status of each run</span>
        <span class="c1"># where self.handler is the record_handler function passed as an argument</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">(</span><span class="n">record</span><span class="p">)</span> <span class="c1"># record_handler passed to decorator/context manager</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_handler</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">failure_handler</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">success_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
        <span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;age&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">success_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">entry</span>


<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="hll"><span class="nd">@batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="n">MyPartialProcessor</span><span class="p">(</span><span class="n">table_name</span><span class="p">))</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h3 id="caveats">Caveats<a class="headerlink" href="#caveats" title="Permanent link">&para;</a></h3>
<h4 id="tracer-response-auto-capture-for-large-batch-sizes">Tracer response auto-capture for large batch sizes<a class="headerlink" href="#tracer-response-auto-capture-for-large-batch-sizes" title="Permanent link">&para;</a></h4>
<p>When using Tracer to capture responses for each batch record processing, you might exceed 64K of tracing data depending on what you return from your <code>record_handler</code> function, or how big is your batch size.</p>
<p>If that's the case, you can configure <a href="../../core/tracer/#disabling-response-auto-capture" target="_blank">Tracer to disable response auto-capturing</a>.</p>
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">Disabling Tracer response auto-capturing</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.sqs_event</span> <span class="kn">import</span> <span class="n">SQSRecord</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">SQS</span><span class="p">)</span>
<span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="hll"><span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span><span class="p">(</span><span class="n">capture_response</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">SQSRecord</span><span class="p">):</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">body</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="o">...</span>

<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="nd">@batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
<h2 id="testing-your-code">Testing your code<a class="headerlink" href="#testing-your-code" title="Permanent link">&para;</a></h2>
<p>As there is no external calls, you can unit test your code with <code>BatchProcessor</code> quite easily.</p>
<p><strong>Example</strong>:</p>
<p>Given a SQS batch where the first batch record succeeds and the second fails processing, we should have a single item reported in the function response.</p>
<div class="tabbed-set" data-tabs="6:3"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><label for="__tabbed_6_1">test_app.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">from</span> <span class="nn">src.app</span> <span class="kn">import</span> <span class="n">lambda_handler</span><span class="p">,</span> <span class="n">processor</span>


<span class="k">def</span> <span class="nf">load_event</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">()</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span> <span class="nf">lambda_context</span><span class="p">():</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span> <span class="nc">LambdaContext</span><span class="p">:</span>
        <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>
        <span class="n">memory_limit_in_mb</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>
        <span class="n">invoked_function_arn</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;arn:aws:lambda:eu-west-1:809313241:function:test&quot;</span>
        <span class="n">aws_request_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;52fdfc07-2182-154f-163f-5f0f9a621d72&quot;</span>

    <span class="k">return</span> <span class="n">LambdaContext</span><span class="p">()</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sqs_event</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Generates API GW Event&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">load_event</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;events/sqs_event.json&quot;</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">test_app_batch_partial_response</span><span class="p">(</span><span class="n">sqs_event</span><span class="p">,</span> <span class="n">lambda_context</span><span class="p">):</span>
    <span class="c1"># GIVEN</span>
    <span class="n">processor</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">processor</span>  <span class="c1"># access processor for additional assertions</span>
    <span class="n">successful_record</span> <span class="o">=</span> <span class="n">sqs_event</span><span class="p">[</span><span class="s2">&quot;Records&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">failed_record</span> <span class="o">=</span> <span class="n">sqs_event</span><span class="p">[</span><span class="s2">&quot;Records&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">expected_response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;batchItemFailures: [</span>
            <span class="p">{</span>
                <span class="s2">&quot;itemIdentifier&quot;</span><span class="p">:</span> <span class="n">failed_record</span><span class="p">[</span><span class="s2">&quot;messageId&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>

    <span class="c1"># WHEN</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">lambda_handler</span><span class="p">(</span><span class="n">sqs_event</span><span class="p">,</span> <span class="n">lambda_context</span><span class="p">)</span>

    <span class="c1"># THEN</span>
    <span class="k">assert</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">expected_response</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">processor</span><span class="o">.</span><span class="n">fail_messages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="k">assert</span> <span class="n">processor</span><span class="o">.</span><span class="n">success_messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">successful_record</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><label for="__tabbed_6_2">src/app.py</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools</span> <span class="kn">import</span> <span class="n">Logger</span><span class="p">,</span> <span class="n">Tracer</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.data_classes.sqs_event</span> <span class="kn">import</span> <span class="n">SQSRecord</span>
<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.typing</span> <span class="kn">import</span> <span class="n">LambdaContext</span>


<span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">SQS</span><span class="p">)</span>
<span class="n">tracer</span> <span class="o">=</span> <span class="n">Tracer</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">Logger</span><span class="p">()</span>


<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_method</span>
<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">SQSRecord</span><span class="p">):</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">body</span>
    <span class="k">if</span> <span class="n">payload</span><span class="p">:</span>
        <span class="n">item</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="o">...</span>

<span class="nd">@logger</span><span class="o">.</span><span class="n">inject_lambda_context</span>
<span class="nd">@tracer</span><span class="o">.</span><span class="n">capture_lambda_handler</span>
<span class="nd">@batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">LambdaContext</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_6_3" name="__tabbed_6" type="radio" /><label for="__tabbed_6_3">Sample SQS event</label><div class="tabbed-content">
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">events/sqs_sample.json</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;Records&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;messageId&quot;</span><span class="p">:</span> <span class="s2">&quot;059f36b4-87a3-44ab-83d2-661975830a7d&quot;</span><span class="p">,</span>
            <span class="nt">&quot;receiptHandle&quot;</span><span class="p">:</span> <span class="s2">&quot;AQEBwJnKyrHigUMZj6rYigCgxlaS3SLy0a&quot;</span><span class="p">,</span>
            <span class="nt">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;{\&quot;Message\&quot;: \&quot;success\&quot;}&quot;</span><span class="p">,</span>
            <span class="nt">&quot;attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ApproximateReceiveCount&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SentTimestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;1545082649183&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SenderId&quot;</span><span class="p">:</span> <span class="s2">&quot;AIDAIENQZJOLO23YVJ4VO&quot;</span><span class="p">,</span>
                <span class="nt">&quot;ApproximateFirstReceiveTimestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;1545082649185&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;messageAttributes&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="nt">&quot;md5OfBody&quot;</span><span class="p">:</span> <span class="s2">&quot;e4e68fb7bd0e697a0ae8f1bb342846b3&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSource&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:sqs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSourceARN&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:sqs:us-east-2: 123456789012:my-queue&quot;</span><span class="p">,</span>
            <span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-1&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;messageId&quot;</span><span class="p">:</span> <span class="s2">&quot;244fc6b4-87a3-44ab-83d2-361172410c3a&quot;</span><span class="p">,</span>
            <span class="nt">&quot;receiptHandle&quot;</span><span class="p">:</span> <span class="s2">&quot;AQEBwJnKyrHigUMZj6rYigCgxlaS3SLy0a&quot;</span><span class="p">,</span>
            <span class="nt">&quot;body&quot;</span><span class="p">:</span> <span class="s2">&quot;SGVsbG8sIHRoaXMgaXMgYSB0ZXN0Lg==&quot;</span><span class="p">,</span>
            <span class="nt">&quot;attributes&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;ApproximateReceiveCount&quot;</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SentTimestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;1545082649183&quot;</span><span class="p">,</span>
                <span class="nt">&quot;SenderId&quot;</span><span class="p">:</span> <span class="s2">&quot;AIDAIENQZJOLO23YVJ4VO&quot;</span><span class="p">,</span>
                <span class="nt">&quot;ApproximateFirstReceiveTimestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;1545082649185&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;messageAttributes&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="nt">&quot;md5OfBody&quot;</span><span class="p">:</span> <span class="s2">&quot;e4e68fb7bd0e697a0ae8f1bb342846b3&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSource&quot;</span><span class="p">:</span> <span class="s2">&quot;aws:sqs&quot;</span><span class="p">,</span>
            <span class="nt">&quot;eventSourceARN&quot;</span><span class="p">:</span> <span class="s2">&quot;arn:aws:sqs:us-east-2: 123456789012:my-queue&quot;</span><span class="p">,</span>
            <span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span> <span class="s2">&quot;us-east-1&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<h2 id="faq">FAQ<a class="headerlink" href="#faq" title="Permanent link">&para;</a></h2>
<h3 id="choosing-between-decorator-and-context-manager">Choosing between decorator and context manager<a class="headerlink" href="#choosing-between-decorator-and-context-manager" title="Permanent link">&para;</a></h3>
<p>Use context manager when you want access to the processed messages or handle <code>BatchProcessingError</code> exception when all records within the batch fail to be processed.</p>
<h3 id="integrating-exception-handling-with-sentryio">Integrating exception handling with Sentry.io<a class="headerlink" href="#integrating-exception-handling-with-sentryio" title="Permanent link">&para;</a></h3>
<p>When using Sentry.io for error monitoring, you can override <code>failure_handler</code> to capture each processing exception with Sentry SDK:</p>
<blockquote>
<p>Credits to <a href="https://github.com/awslabs/aws-lambda-powertools-python/issues/293#issuecomment-781961732">Charles-Axel Dein</a></p>
</blockquote>
<table class="highlighttable"><tr><th colspan="2" class="filename"><div class="highlight"><span class="filename">Integrating error tracking with Sentry.io</span></div></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">FailureResponse</span>
<span class="hll"><span class="kn">from</span> <span class="nn">sentry_sdk</span> <span class="kn">import</span> <span class="n">capture_exception</span>
</span>

<span class="hll"><span class="k">class</span> <span class="nc">MyProcessor</span><span class="p">(</span><span class="n">BatchProcessor</span><span class="p">):</span>
</span><span class="hll">    <span class="k">def</span> <span class="nf">failure_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FailureResponse</span><span class="p">:</span>
</span>        <span class="n">capture_exception</span><span class="p">()</span>  <span class="c1"># send exception to Sentry</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">failure_handler</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">exception</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>
<h2 id="legacy">Legacy<a class="headerlink" href="#legacy" title="Permanent link">&para;</a></h2>
<details class="tip" open="open">
<summary>Tip</summary>
<p>This is kept for historical purposes. Use the new <a href="#processing-messages-from-sqs">BatchProcessor</a> instead.</p>
</details>
<h3 id="migration-guide">Migration guide<a class="headerlink" href="#migration-guide" title="Permanent link">&para;</a></h3>
<details class="info" open="open">
<summary>Info</summary>
<p>Keep reading if you are using <code>sqs_batch_processor</code> or <code>PartialSQSProcessor</code>.</p>
</details>
<p><a href="https://aws.amazon.com/about-aws/whats-new/2021/11/aws-lambda-partial-batch-response-sqs-event-source/" target="_blank">As of Nov 2021</a>, this is no longer needed as both SQS, Kinesis, and DynamoDB Streams offer this capability natively with one caveat - it's an <a href="#required-resources">opt-in feature</a>.</p>
<p>Being a native feature, we no longer need to instantiate boto3 nor other customizations like exception suppressing â€“ this lowers the cost of your Lambda function as you can delegate deleting partial failures to Lambda.</p>
<details class="tip" open="open">
<summary>Tip</summary>
<p>It's also easier to test since it's mostly a <a href="https://docs.aws.amazon.com/lambda/latest/dg/with-sqs.html#sqs-batchfailurereporting-syntax" target="_blank">contract based response</a>.</p>
</details>
<p>You can migrate in three steps:</p>
<ol>
<li>If you are using <strong><code>sqs_batch_decorator</code></strong> you can now use <strong><code>batch_processor</code></strong> decorator</li>
<li>If you were using <strong><code>PartialSQSProcessor</code></strong> you can now use <strong><code>BatchProcessor</code></strong></li>
<li>Change your Lambda Handler to return the new response format</li>
</ol>
<div class="tabbed-set" data-tabs="7:4"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><label for="__tabbed_7_1">Decorator: Before</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">sqs_batch_processor</span>
</span>
<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>

<span class="hll"><span class="nd">@sqs_batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><label for="__tabbed_7_2">Decorator: After</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>

<span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
</span>
<span class="hll"><span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">SQS</span><span class="p">)</span>
</span>

<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>

<span class="hll"><span class="nd">@batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">processor</span><span class="o">=</span><span class="n">processor</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_7_3" name="__tabbed_7" type="radio" /><label for="__tabbed_7_3">Context manager: Before</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">PartialSQSProcessor</span>
</span><span class="hll"><span class="kn">from</span> <span class="nn">botocore.config</span> <span class="kn">import</span> <span class="n">Config</span>
</span>
<span class="hll"><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span><span class="p">)</span>
</span>
<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">return_value</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;Records&quot;</span><span class="p">]</span>

<span class="hll">    <span class="n">processor</span> <span class="o">=</span> <span class="n">PartialSQSProcessor</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span>
    <span class="k">with</span> <span class="n">processor</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">record_handler</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

<span class="hll">    <span class="k">return</span> <span class="n">result</span>
</span></code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_7_4" name="__tabbed_7" type="radio" /><label for="__tabbed_7_4">Context manager: After</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="hll"><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">BatchProcessor</span><span class="p">,</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">batch_processor</span>
</span>

<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">return_value</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;Records&quot;</span><span class="p">]</span>

<span class="hll">    <span class="n">processor</span> <span class="o">=</span> <span class="n">BatchProcessor</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">EventType</span><span class="o">.</span><span class="n">SQS</span><span class="p">)</span>
</span>
    <span class="k">with</span> <span class="n">processor</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">record_handler</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">processor</span><span class="o">.</span><span class="n">response</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<h3 id="customizing-boto-configuration">Customizing boto configuration<a class="headerlink" href="#customizing-boto-configuration" title="Permanent link">&para;</a></h3>
<p>The <strong><code>config</code></strong> and <strong><code>boto3_session</code></strong> parameters enable you to pass in a custom <a href="https://botocore.amazonaws.com/v1/documentation/api/latest/reference/config.html">botocore config object</a>
or a custom <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/core/session.html">boto3 session</a> when using the <code>sqs_batch_processor</code>
decorator or <code>PartialSQSProcessor</code> class.</p>
<blockquote>
<p>Custom config example</p>
</blockquote>
<div class="tabbed-set" data-tabs="8:2"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><label for="__tabbed_8_1">Decorator</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">sqs_batch_processor</span>
<span class="kn">from</span> <span class="nn">botocore.config</span> <span class="kn">import</span> <span class="n">Config</span>

<span class="hll"><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span><span class="p">)</span>
</span>
<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="c1"># This will be called for each individual message from a batch</span>
    <span class="c1"># It should raise an exception if the message was not processed successfully</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">return_value</span>

<span class="hll"><span class="nd">@sqs_batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><label for="__tabbed_8_2">Context manager</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">PartialSQSProcessor</span>
<span class="kn">from</span> <span class="nn">botocore.config</span> <span class="kn">import</span> <span class="n">Config</span>

<span class="hll"><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">(</span><span class="n">region_name</span><span class="o">=</span><span class="s2">&quot;us-east-1&quot;</span><span class="p">)</span>
</span>
<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="c1"># This will be called for each individual message from a batch</span>
    <span class="c1"># It should raise an exception if the message was not processed successfully</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">return_value</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;Records&quot;</span><span class="p">]</span>

<span class="hll">    <span class="n">processor</span> <span class="o">=</span> <span class="n">PartialSQSProcessor</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">)</span>
</span>
    <span class="k">with</span> <span class="n">processor</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">record_handler</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<blockquote>
<p>Custom boto3 session example</p>
</blockquote>
<div class="tabbed-set" data-tabs="9:2"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><label for="__tabbed_9_1">Decorator</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">sqs_batch_processor</span>
<span class="kn">from</span> <span class="nn">botocore.config</span> <span class="kn">import</span> <span class="n">Config</span>

<span class="hll"><span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span>
<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="c1"># This will be called for each individual message from a batch</span>
    <span class="c1"># It should raise an exception if the message was not processed successfully</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">return_value</span>

<span class="hll"><span class="nd">@sqs_batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">boto3_session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_9_2" name="__tabbed_9" type="radio" /><label for="__tabbed_9_2">Context manager</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">PartialSQSProcessor</span>
<span class="kn">import</span> <span class="nn">boto3</span>

<span class="hll"><span class="n">session</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span>
<span class="k">def</span> <span class="nf">record_handler</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
    <span class="c1"># This will be called for each individual message from a batch</span>
    <span class="c1"># It should raise an exception if the message was not processed successfully</span>
    <span class="n">return_value</span> <span class="o">=</span> <span class="n">do_something_with</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;body&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">return_value</span>


<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">records</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;Records&quot;</span><span class="p">]</span>

<span class="hll">    <span class="n">processor</span> <span class="o">=</span> <span class="n">PartialSQSProcessor</span><span class="p">(</span><span class="n">boto3_session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
</span>
    <span class="k">with</span> <span class="n">processor</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">record_handler</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
<h3 id="suppressing-exceptions">Suppressing exceptions<a class="headerlink" href="#suppressing-exceptions" title="Permanent link">&para;</a></h3>
<p>If you want to disable the default behavior where <code>SQSBatchProcessingError</code> is raised if there are any errors, you can pass the <code>suppress_exception</code> boolean argument.</p>
<div class="tabbed-set" data-tabs="10:2"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><label for="__tabbed_10_1">Decorator</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">sqs_batch_processor</span>

<span class="hll"><span class="nd">@sqs_batch_processor</span><span class="p">(</span><span class="n">record_handler</span><span class="o">=</span><span class="n">record_handler</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">suppress_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
</div>
<input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><label for="__tabbed_10_2">Context manager</label><div class="tabbed-content">
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_lambda_powertools.utilities.batch</span> <span class="kn">import</span> <span class="n">PartialSQSProcessor</span>

<span class="hll"><span class="n">processor</span> <span class="o">=</span> <span class="n">PartialSQSProcessor</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span> <span class="n">suppress_exception</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span>
<span class="k">with</span> <span class="n">processor</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">record_handler</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">processor</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>
</div>
</div>
                
                  
                    

<hr>
<div class="md-source-date">
  <small>
    
      Last update: 2022-01-18
    
  </small>
</div>
                  
                
              
              
                


              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            Back to top
          </a>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../parameters/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Parameters" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Parameters
            </div>
          </div>
        </a>
      
      
        
        <a href="../typing/" class="md-footer__link md-footer__link--next" aria-label="Next: Typing" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Typing
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2021 Amazon Web Services
          </div>
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "navigation.instant", "navigation.indexes"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.b1047164.min.js"></script>
      
        <script src="../../javascript/aws-amplify.min.js"></script>
      
        <script src="../../javascript/extra.js"></script>
      
    
  </body>
</html>